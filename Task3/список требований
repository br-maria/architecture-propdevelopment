# Требования к внешним интеграциям PropDevelopment («Умный дом»)

## A. Требования к безопасности интеграций

### A1. Сетевой и транспортный уровень
- Только TLS 1.2+ (рекомендован TLS 1.3). Запрет HTTP без TLS и слабых шифров.
- mTLS для server-to-server API (PropDevelopment ↔ партнёр). Выпуск и ротация клиентских сертификатов по политике (≤90 дней).
- IP-allowlist/VPN/VPC Peering: вызовы разрешены только с согласованных подсетей/туннелей.
- WAF/Rate-Limit на периметре партнёра и у нас (на Smart Access Gateway).

### A2. Защита данных и ключей
- Шифрование “в покое” (AES-256 или экв.) у обеих сторон; в том числе бэкапы.
- KMS/HSM, ротация ключей ≤ 180 дней; запрет «жёстко зашитых» секретов.
- Secrets Management (Vault/Cloud KMS) для token/ключей, с аудитом чтений.

### A3. Конфиденциальность и закон
- Минимизация данных: передаём только то, что нужно для сценария доступа.  
  — биометрия (шаблоны лиц) хранится у партнёра, у нас — только ссылки/идентификаторы и статусы согласия.  
  — госномера авто — только хеш/нормализованный номер, где возможно.
- Локализация и трансграничность: хранение и обработка ПДн в соответствии с законами РФ; отдельное согласование, если есть трансграничная передача.
- Согласия/правовые основания: явное согласие на биометрию, срок и цель обработки; механизмы opt-out/удаления.
- Политика хранения (retention): события доступа — срок хранится у нас (например, 12 мес.), у партнёра — не дольше оговорённого TTL.

### A4. Надёжность и отказоустойчивость
- SLA/SLO: доступность API партнёра ≥ 99.9%, максимальная задержка ответа ≤ 500 мс для команд открытия.
- Идемпотентность: Idempotency-Key на командах; повторная доставка событий допустима — обязателен event_id и occurred_at.
- Ретраи с backoff + circuit breaker. DLQ для невоспроизведённых событий.
- Версионирование API: семантическое v1/v2, backward-compatible изменения, политика депривации ≥ 6 мес., “contract first” (OpenAPI 3.1).

### A5. Наблюдаемость, журналирование, IR
- Корреляция: обязательные заголовки X-Correlation-Id/traceparent.  
- Аудит: логи безопасности без ПДн/секретов, хранение ≥ 12 мес., передача в SIEM.  
- Метрики: QPS, успех/ошибка, латентность p95/p99, количество ретраев, дропов.
- Инфобез-процедуры: обмен контактами on-call, 24×7 инциденты, RACI, сроки уведомления о нарушениях безопасности ≤ 24 ч.
- Тесты безопасности: ежегодный pentest/ASV, регулярные OWASP API Top-10 проверки, отчёты с планом ремедиации.

### A6. Качество контрактов
- OpenAPI 3.1 / JSON Schema как единый источник правды.
- Контрактные тесты (consumer-driven), среда sandbox с синтетическими данными.
- Политика изменений — pull-request + совместное ревью безопасности.

---

## B. Протоколы аутентификации и авторизации

### B1. Межсистемные вызовы (наша платформа → партнёр)
- OAuth 2.1 Client Credentials (или mTLS-OAuth):  
  — token_endpoint партнёра, audience = smart-home-api;  
  — ограниченные scopes: access:open, access:enroll-face, access:plate, access:read-events и т.п.;  
  — срок жизни access-token ≤ 10 мин., refresh-token не используется.  
- JWS (JWT): алгоритм PS256/ES256, обязательные iss, sub, aud, exp, nbf, jti; проверка ревокации/списка клиентов.  
- ABAC на нашей стороне: все вызовы через Smart Access Gateway — валидация claims и привязка к tenant_id/house_id/entry_id.  

### B2. Вебхуки (партнёр → наша платформа)
- TLS 1.2+; подпись webhook (X-Signature: HMAC-SHA256 по телу + timestamp в заголовке).  
- Проверки: окно времени (±5 мин), nonce/jti → защита от повторов, сверка kid с активным ключом, ротация ключей.  
- Ответы 2xx только после дедупликации и записи в журнал; 409 при повторных event_id.  

### B3. Пользовательский доступ (моб. приложение → наша платформа)
- OIDC с PKCE (через корпоративный IdP).  
- Access-token (JWT) используется к tenant-core-app; backend-for-frontend: мобильное приложение не ходит к партнёру напрямую.  
- Роли/клеймы: sub, tenant_id, owner_id, список разрешённых объектов/зон, флаги согласия на биометрию.  

---

## C. Организация взаимодействия

### C1. Команда «Открыть дверь/шлагбаум»
1. Mobile App → tenant-core-app (REST, JWT): запрос на действие по объекту/точке доступа.  
2. tenant-core-app → Smart Access Gateway: валидация прав (ABAC), привязка к зоне.  
3. Gateway → Partner API: POST /access/open с Idempotency-Key, X-Correlation-Id.  
4. Партнёр управляет Intercom/Barrier → устройство Edge; возвращает command_id.  
5. Партнёр присылает webhook access.opened/denied → Gateway.  
6. Gateway журналирует событие в smart-access-db, публикует уведомление пользователю (через tenant-core-app) и при необходимости отсылает метрики/логи в SIEM/DWH (CDC).  

### C2. Регистрация/удаление шаблона лица и госномера
- Лицо: у нас только face_template_id + статус согласия.  
- Номер авто: белый список у нас; у партнёра — нормализованный номер/хеш.  
- Операции через Gateway: enroll, revoke, list → Partner API.  

### C3. Событийная модель
- Вебхуки партнёра: face.recognized, plate.recognized, access.opened, access.denied, device.offline/online.  
- Формат: JSON, поля event_id, occurred_at, tenant_id, house_id, device_id, subject_type (owner/guest), без ПДн.  
- Доставка: at-least-once, ретраи с backoff; дедупликация по event_id.  
- CDC: smart-access-db → DWH, темы: access_events, device_health.  

### C4. Контроль качества интеграции
- E2E-мониторинг транзакций «команда→webhook» с SLA (≤ 2 с p95).  
- Контроль схем (Schema Registry); контрактные тесты на PR партнёра.  
- Каталог интеграций: владелец, цели, классификация данных, правовые основания, эндпоинты, версии, ключи, сроки.  

---

## D. Итоговый чек-лист для договора/приёмки

1. TLS 1.2+/mTLS; IP-allowlist или VPN.  
2. OAuth 2.1 CC + ограниченные scopes; JWS PS256/ES256.  
3. Webhook HMAC-подпись + дедупликация event_id, окно времени, nonce.  
4. Минимизация ПДн, биометрия только у партнёра; согласия и opt-out.  
5. OpenAPI 3.1 + contract tests; sandbox.  
6. Идемпотентность, retry policy, circuit breaker.  
7. Логи, метрики, трейсинг, SIEM, IRP инцидентов.  
8. KMS/HSM, ротация ключей/сертификатов.  
9. SLA/SLO, лимиты и rate-limit headers.  
10. Версионирование и депривация ≥ 6 мес.; changelog/коммуникации.
